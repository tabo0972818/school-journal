<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title><%= title || "ç”Ÿå¾’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" %></title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      font-family: "Segoe UI","Noto Sans JP",sans-serif;
      background:#f5f7fa;
      margin:0;padding:0;
    }
    header {
      display:flex;justify-content:space-between;align-items:center;
      background:#0078d4;color:white;padding:15px 20px;font-size:1.2em;
    }
    header img {
      width:36px;height:36px;cursor:pointer;border-radius:6px;transition:.3s;
    }
    header img:hover { background:rgba(255,255,255,0.3); }
    main { max-width:1100px;margin:auto;padding:25px; }
    h2 { border-left:5px solid #0078d4;padding-left:10px;color:#0078d4; }
    table {
      width:100%;border-collapse:collapse;margin-top:10px;
      background:white;box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    th, td {
      border:1px solid #ddd;padding:8px;text-align:center;
    }
    th { background:#0078d4;color:white; }
    tr:nth-child(even){background:#f9f9f9;}
    textarea, select {
      width:100%;padding:6px;margin:5px 0;border:1px solid #ccc;border-radius:5px;
    }
    button {
      background:#0078d4;color:white;border:none;border-radius:5px;
      padding:8px 15px;cursor:pointer;margin-top:8px;
    }
    button:hover { background:#005fa3; }
    form { background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    #chart { width:100%;max-height:400px; }
  </style>
</head>
<body>
<header>
  <h1>ğŸ“˜ ç”Ÿå¾’ãƒšãƒ¼ã‚¸ï¼ˆ<%= studentName %>ï¼‰</h1>
  <img src="/images/logout.png" alt="logout" onclick="logout()">
</header>

<main>
  <% if (alertMessage) { %>
    <p style="color:red;font-weight:bold;"><%= alertMessage %></p>
  <% } %>

  <!-- ğŸ“ æå‡ºãƒ•ã‚©ãƒ¼ãƒ  -->
  <section>
    <h2>ğŸ“ æå‡ºãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‰ç™»æ ¡æ—¥åˆ†ã®ã¿ï¼‰</h2>
    <form method="POST" action="/student/submit">
      <label>ä½“èª¿ï¼š</label>
      <select name="condition" required>
        <option value="">é¸æŠ</option>
        <option value="3">ã‚ˆã„</option>
        <option value="2">ãµã¤ã†</option>
        <option value="1">ã‚ã‚‹ã„</option>
      </select>

      <label>ãƒ¡ãƒ³ã‚¿ãƒ«ï¼š</label>
      <select name="mental" required>
        <option value="">é¸æŠ</option>
        <option value="3">å…ƒæ°—</option>
        <option value="2">ãµã¤ã†</option>
        <option value="1">ç–²ã‚Œæ°—å‘³</option>
      </select>

      <label>ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šï¼š</label>
      <textarea name="reflection" rows="4" required></textarea>

      <button type="submit">æå‡º</button>
    </form>
  </section>

  <!-- ğŸ“… æå‡ºå±¥æ­´ -->
  <section>
    <h2>ğŸ“… æå‡ºå±¥æ­´</h2>
    <table>
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>ä½“èª¿</th>
          <th>ãƒ¡ãƒ³ã‚¿ãƒ«</th>
          <th>æŒ¯ã‚Šè¿”ã‚Š</th>
          <th>çŠ¶æ…‹</th>
          <th>æ‹…ä»»ã‚³ãƒ¡ãƒ³ãƒˆ</th>
        </tr>
      </thead>
      <tbody>
        <% if (entries.length) { %>
          <% entries.forEach(e => { %>
            <tr>
              <td><%= e.date %></td>
              <td>
                <% if (e.condition == 3) { %>ğŸ˜Š ã‚ˆã„
                <% } else if (e.condition == 2) { %>ğŸ˜ ãµã¤ã†
                <% } else if (e.condition == 1) { %>ğŸ˜ ã‚ã‚‹ã„
                <% } else { %>-<% } %>
              </td>
              <td>
                <% if (e.mental == 3) { %>ğŸ’ª å…ƒæ°—
                <% } else if (e.mental == 2) { %>ğŸ˜Œ ãµã¤ã†
                <% } else if (e.mental == 1) { %>ğŸ˜£ ç–²ã‚Œæ°—å‘³
                <% } else { %>-<% } %>
              </td>
              <td style="text-align:left;"><%= e.reflection %></td>
              <td>
                <% if (e.is_read == 1) { %>âœ… æ—¢èª­
                <% } else { %>ğŸ•“ æœªèª­<% } %>
              </td>
              <td style="text-align:left;color:#0078d4;"><%= e.teacher_comment || "-" %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="6">ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
        <% } %>
      </tbody>
    </table>
  </section>

  <!-- ğŸ“Š æ¨ç§»ã‚°ãƒ©ãƒ• -->
  <section>
    <h2>ğŸ“Š ä½“èª¿ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«æ¨ç§»</h2>
    <canvas id="chart"></canvas>
  </section>
</main>

<script>
  const chartData = <%- JSON.stringify(chartData || []) %>;

  if (chartData.length) {
    const ctx = document.getElementById("chart");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: chartData.map(e => e.date),
        datasets: [
          {
            label: "ä½“èª¿",
            data: chartData.map(e => Number(e.condition)),
            borderColor: "rgba(54,162,235,1)",
            backgroundColor: "rgba(54,162,235,0.2)",
            fill: true,
            tension: 0.2
          },
          {
            label: "ãƒ¡ãƒ³ã‚¿ãƒ«",
            data: chartData.map(e => Number(e.mental)),
            borderColor: "rgba(255,99,132,1)",
            backgroundColor: "rgba(255,99,132,0.2)",
            fill: true,
            tension: 0.2
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 3,
            ticks: {
              stepSize: 1,
              callback: value => {
                if (value === 1) return "ä½";
                if (value === 2) return "ä¸­";
                if (value === 3) return "é«˜";
                return value;
              }
            }
          }
        },
        plugins: { legend: { position: "bottom" } }
      }
    });
  }

  function logout() {
    if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
      location.href = "/logout";
    }
  }
</script>
</body>
</html>
