<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI","Noto Sans JP",sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0078d4;
      color: white;
      padding: 15px 20px;
      font-size: 1.2em;
    }
    header img {
      width: 36px;
      height: 36px;
      cursor: pointer;
      border-radius: 6px;
      transition: .3s;
    }
    header img:hover {
      background: rgba(255,255,255,0.3);
    }
    main {
      max-width: 1000px;
      margin: auto;
      padding: 25px;
    }
    h2 {
      border-left: 5px solid #0078d4;
      padding-left: 10px;
      color: #0078d4;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    select, textarea, button, input[type="date"] {
      font-size: 1em;
      margin: 6px 0;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    select, textarea, input[type="date"] {
      width: 100%;
    }
    button {
      background: #0078d4;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: .3s;
    }
    button:hover {
      background: #005fa3;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #0078d4;
      color: white;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    .status-read {
      color: green;
      font-weight: bold;
    }
    .status-unread {
      color: red;
      font-weight: bold;
    }
    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: #333;
      color: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 10000;
      font-size: 0.95em;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    @media (max-width:768px) {
      main { padding: 15px; }
      table { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <img id="school-logo" src="/images/school_logo.png" alt="School Logo" onclick="goHome()">
  <header>
    <h1>ğŸ“˜ ç”Ÿå¾’ãƒšãƒ¼ã‚¸ï¼ˆ<%= student.name %> / <%= student.class_name %>ï¼‰</h1>
    <img src="/images/logout.png" alt="logout" onclick="logout()">
  </header>

  <main>
    <% if (alertMessage) { %>
      <p id="alertMsg" style="display:none;"><%= alertMessage %></p>
    <% } %>

    <section>
      <h2>ğŸ“ æå‡ºãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‰ç™»æ ¡æ—¥ã®ã¿ï¼‰</h2>
      <%
        const todayStr = new Date(Date.now() + 9 * 60 * 60 * 1000).toISOString().slice(0, 10);
        const todayEntry = entries.find(e => e.date === todayStr);
        const isLocked = (todayEntry && todayEntry.is_read === 1);
      %>
      <% if (isLocked) { %>
        <div style="background:#ffe5e5;border:1px solid #ff9999;color:#c00;padding:12px;border-radius:8px;margin-bottom:15px;text-align:center;">
          âš ï¸ æ‹…ä»»ãŒç¢ºèªæ¸ˆã¿ã®ãŸã‚ã€å†æå‡ºãƒ»ä¿®æ­£ã¯ã§ãã¾ã›ã‚“ã€‚
        </div>
      <% } %>

      <form method="POST" action="/student">
        <input type="hidden" name="student_id" value="<%= student.id %>">
        <label>ä½“èª¿ï¼š</label>
        <select name="condition" <%= isLocked ? "disabled" : "" %> required>
          <option value="">é¸æŠ</option>
          <option value="5" <%= todayEntry && todayEntry.condition == 5 ? "selected" : "" %>>ğŸŒˆ ã¨ã¦ã‚‚ã‚ˆã„</option>
          <option value="4" <%= todayEntry && todayEntry.condition == 4 ? "selected" : "" %>>ğŸ˜Š ã‚ˆã„</option>
          <option value="3" <%= todayEntry && todayEntry.condition == 3 ? "selected" : "" %>>ğŸ˜ æ™®é€š</option>
          <option value="2" <%= todayEntry && todayEntry.condition == 2 ? "selected" : "" %>>ğŸ˜ å°‘ã—ã‚ã‚‹ã„</option>
          <option value="1" <%= todayEntry && todayEntry.condition == 1 ? "selected" : "" %>>ğŸ’¤ ã‹ãªã‚Šã‚ã‚‹ã„</option>
        </select>

        <label>ãƒ¡ãƒ³ã‚¿ãƒ«ï¼š</label>
        <select name="mental" <%= isLocked ? "disabled" : "" %> required>
          <option value="">é¸æŠ</option>
          <option value="5" <%= todayEntry && todayEntry.mental == 5 ? "selected" : "" %>>ğŸ’ª ã¨ã¦ã‚‚å…ƒæ°—</option>
          <option value="4" <%= todayEntry && todayEntry.mental == 4 ? "selected" : "" %>>ğŸ™‚ å…ƒæ°—</option>
          <option value="3" <%= todayEntry && todayEntry.mental == 3 ? "selected" : "" %>>ğŸ˜Œ æ™®é€š</option>
          <option value="2" <%= todayEntry && todayEntry.mental == 2 ? "selected" : "" %>>ğŸ˜£ ã‚„ã‚„ä¸èª¿</option>
          <option value="1" <%= todayEntry && todayEntry.mental == 1 ? "selected" : "" %>>ğŸ˜­ ã‹ãªã‚Šä¸èª¿</option>
        </select>

        <label>ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šï¼š</label>
        <textarea name="reflection" rows="3" placeholder="ä¾‹ï¼šæˆæ¥­ã§ã€‡ã€‡ã‚’å­¦ã‚“ã ..." <%= isLocked ? "disabled" : "" %> required><%= todayEntry ? todayEntry.reflection : "" %></textarea>

        <label>ç›¸è«‡æ¬„ï¼ˆä»»æ„ï¼‰ï¼š</label>
        <textarea name="consultation" rows="3" placeholder="æ‚©ã¿ãƒ»ç›¸è«‡ãªã©ï¼ˆæ‹…ä»»ã®ã¿é–²è¦§å¯ï¼‰" <%= isLocked ? "disabled" : "" %>><%= todayEntry ? todayEntry.consultation : "" %></textarea>

        <button type="submit" <%= isLocked ? "disabled" : "" %>><%= todayEntry ? "ä¿®æ­£ã‚’æå‡º" : "æå‡º" %></button>
      </form>
    </section>

    <section>
      <h2>ğŸ“‹ æå‡ºå±¥æ­´</h2>
      <div style="margin-bottom:10px;">
        <label>æœŸé–“ï¼š</label>
        <input type="date" id="filterFrom"> ï½ 
        <input type="date" id="filterTo">
        <button onclick="filterByRange()">çµã‚Šè¾¼ã¿</button>
        <button onclick="resetRange()">ãƒªã‚»ãƒƒãƒˆ</button>
        <button onclick="updateGraph()">ğŸ“Š ã‚°ãƒ©ãƒ•æ›´æ–°</button>
        <button onclick="exportToPDF('entryTable','student_entries')">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
        <button onclick="exportToCSV('entryTable','student_entries')">ğŸ“„ CSVå‡ºåŠ›</button>
      </div>

      <table id="entryTable">
        <thead>
          <tr>
            <th>æ—¥ä»˜</th>
            <th>ä½“èª¿</th>
            <th>ãƒ¡ãƒ³ã‚¿ãƒ«</th>
            <th>æŒ¯ã‚Šè¿”ã‚Š</th>
            <th>çŠ¶æ…‹</th>
            <th>æ‹…ä»»ã‚³ãƒ¡ãƒ³ãƒˆ</th>
          </tr>
        </thead>
        <tbody>
          <% if (entries && entries.length) { %>
            <% entries.forEach(e => { %>
              <tr data-date="<%= e.date %>" data-condition="<%= e.condition %>" data-mental="<%= e.mental %>">
                <td><%= e.date %></td>
                <td><%= e.condition ? e.condition : "-" %></td>
                <td><%= e.mental ? e.mental : "-" %></td>
                <td style="text-align:left;"><%= e.reflection || "" %></td>
                <td class="<%= e.is_read ? 'status-read' : 'status-unread' %>"><%= e.is_read ? "âœ… æ—¢èª­" : "â° æœªèª­" %></td>
                <td style="text-align:left;"><%= e.teacher_comment || "-" %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="6">ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
          <% } %>
        </tbody>
      </table>

      <div style="margin-top:25px;">
        <h2>ğŸ“ˆ æœŸé–“å†…ã®å¹³å‡ï¼ˆä½“èª¿ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«ï¼‰</h2>
        <canvas id="avgChart"></canvas>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
window.logout=function(){
  if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
    sessionStorage.clear();
    window.location.href="/logout";
  }
};

window.exportToCSV=function(tableId,filename){
  const table=document.getElementById(tableId);
  if(!table)return alert("å‡ºåŠ›å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  const rows=[...table.querySelectorAll("tr")];
  const csv=rows.map(r=>[...r.children].map(c=>`"${(c.innerText||"").replace(/\r?\n/g," ").replace(/"/g,'""')}"`).join(",")).join("\r\n");
  const bom=new Uint8Array([0xEF,0xBB,0xBF]);
  const blob=new Blob([bom,csv],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=filename+".csv";
  link.click();
};

window.exportToPDF=function(elementId,filename){
  const element=document.getElementById(elementId);
  if(!element)return alert("å‡ºåŠ›å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  const tbody=element.querySelector("tbody");
  if(tbody&&tbody.children.length===0){
    tbody.innerHTML="<tr><td colspan='6' style='text-align:center;color:#555;'>å‡ºåŠ›ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>";
  }
  const clone=element.cloneNode(true);
  clone.style.margin="0 auto";
  clone.style.display="table";
  clone.style.borderCollapse="collapse";
  clone.style.backgroundColor="#fff";
  const wrapper=document.createElement("div");
  wrapper.style.width="100%";
  wrapper.style.textAlign="center";
  wrapper.style.paddingTop="40px";
  wrapper.style.backgroundColor="#fff";
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);
  window.scrollTo(0,0);
  const opt={
    margin:[20,20,20,20],
    filename:filename+".pdf",
    image:{type:"jpeg",quality:1},
    html2canvas:{scale:2,useCORS:true,backgroundColor:"#ffffff"},
    jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},
    pagebreak:{mode:["avoid-all"]}
  };
  setTimeout(()=>{
    html2pdf().set(opt).from(wrapper).save().then(()=>wrapper.remove())
    .catch(err=>{console.error("PDFå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:",err);alert("PDFå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");wrapper.remove();});
  },400);
};

window.filterByRange=function(){
  const from=document.getElementById("filterFrom").value;
  const to=document.getElementById("filterTo").value;
  document.querySelectorAll("#entryTable tbody tr").forEach(r=>{
    const date=r.dataset.date;
    let show=true;
    if(from&&date<from)show=false;
    if(to&&date>to)show=false;
    r.style.display=show?"":"none";
  });
};

window.resetRange=function(){
  document.getElementById("filterFrom").value="";
  document.getElementById("filterTo").value="";
  document.querySelectorAll("#entryTable tbody tr").forEach(r=>r.style.display="");
  updateGraph();
};

let chart;
window.updateGraph=function(){
  const from=document.getElementById("filterFrom").value;
  const to=document.getElementById("filterTo").value;
  const rows=[...document.querySelectorAll("#entryTable tbody tr")];
  const filtered=rows.filter(r=>{
    const d=r.dataset.date;
    if(!d)return false;
    if(from&&d<from)return false;
    if(to&&d>to)return false;
    return true;
  }).map(r=>({condition:Number(r.dataset.condition)||0,mental:Number(r.dataset.mental)||0}));
  const avgCondition=filtered.length?(filtered.reduce((s,e)=>s+e.condition,0)/filtered.length).toFixed(2):0;
  const avgMental=filtered.length?(filtered.reduce((s,e)=>s+e.mental,0)/filtered.length).toFixed(2):0;
  const ctx=document.getElementById("avgChart").getContext("2d");
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{labels:["ä½“èª¿","ãƒ¡ãƒ³ã‚¿ãƒ«"],datasets:[{label:"å¹³å‡ã‚¹ã‚³ã‚¢",data:[avgCondition,avgMental],backgroundColor:["#4e79a7","#f28e2b"]}]},
    options:{scales:{y:{beginAtZero:true,max:5,ticks:{stepSize:1}}},plugins:{legend:{display:false}}}
  });
};

function goHome(){
  const path=window.location.pathname;
  if(path.includes("admin"))location.href="/admin";
  else if(path.includes("teacher"))location.href="/teacher";
  else if(path.includes("student"))location.href="/student";
  else location.href="/";
}

/* âœ… æ—¥æœ¬èªå¯¾å¿œãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
function showToast(message,type="success"){
  const toast=document.getElementById("toast");
  if(!toast)return;
  toast.textContent=message;
  toast.style.background=type==="error"?"#c62828":"#2e7d32"; // æˆåŠŸâ†’ç·‘, å¤±æ•—â†’èµ¤
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2500);
}

document.addEventListener("DOMContentLoaded",()=>{
  updateGraph();
  const msg=document.getElementById("alertMsg");
  if(msg&&msg.textContent.trim()){
    let text=msg.textContent.trim();
    if(text.toLowerCase().includes("success")) text="âœ… æå‡ºãŒå®Œäº†ã—ã¾ã—ãŸ";
    if(text.toLowerCase().includes("error")) text="âš ï¸ æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ";
    showToast(text);
  }
});
</script>
</body>
</html>
