<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI","Noto Sans JP",sans-serif;
      background:#f5f7fa;margin:0;padding:0;
    }
    header {
      display:flex;justify-content:space-between;align-items:center;
      background:#0078d4;color:white;padding:15px 20px;font-size:1.2em;
    }
    header img {
      width:36px;height:36px;cursor:pointer;border-radius:6px;transition:.3s;
    }
    header img:hover { background:rgba(255,255,255,0.3); }
    main { max-width:1000px;margin:auto;padding:25px; }
    h2 { border-left:5px solid #0078d4;padding-left:10px;color:#0078d4; }

    form {
      background:#fff;padding:20px;border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:25px;
    }
    select,textarea,button {
      font-size:1em;margin:6px 0;padding:8px;border-radius:5px;border:1px solid #ccc;
    }
    select,textarea { width:100%; }
    button {
      background:#0078d4;color:#fff;border:none;padding:8px 16px;
      border-radius:5px;cursor:pointer;transition:.3s;
    }
    button:hover { background:#005fa3; }

    table {
      width:100%;border-collapse:collapse;background:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    th,td {
      border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap;
    }
    th { background:#0078d4;color:white; }
    tr:nth-child(even){background:#f9f9f9;}
    .status-read { color:green;font-weight:bold; }
    .status-unread { color:red;font-weight:bold; }

    /* âœ… ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast {
      position: fixed;top: 20px;right: 20px;
      background: rgba(0,0,0,0.85);color: #fff;
      padding: 12px 18px;border-radius: 8px;
      opacity: 0;pointer-events: none;
      transition: opacity 0.4s, transform 0.4s;
      transform: translateY(-20px);z-index: 1000;
    }
    .toast.show { opacity: 1;transform: translateY(0);pointer-events: auto; }
    .toast.success { background: #009a3d; }
    .toast.error { background: #d93025; }

    @media (max-width:768px){
      main{padding:15px;}
      table{font-size:0.9em;}
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“˜ ç”Ÿå¾’ãƒšãƒ¼ã‚¸ï¼ˆ<%= student.name %> / <%= student.class_name %>ï¼‰</h1>
    <img src="/images/logout.png" alt="logout" onclick="logout()">
  </header>

  <main>
    <% if (alertMessage) { %>
      <p id="alertMsg" style="display:none;"><%= alertMessage %></p>
    <% } %>

    <!-- ğŸ“ æå‡ºãƒ•ã‚©ãƒ¼ãƒ  -->
    <section>
      <h2>ğŸ“ æå‡ºãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‰ç™»æ ¡æ—¥ã®ã¿ï¼‰</h2>
      <form method="POST" action="/student">
        <input type="hidden" name="student_id" value="<%= student.id %>">

        <label>ä½“èª¿ï¼š</label>
        <select name="condition" required>
          <option value="">é¸æŠ</option>
          <option value="5">ğŸŒˆ ã¨ã¦ã‚‚ã‚ˆã„</option>
          <option value="4">ğŸ˜Š ã‚ˆã„</option>
          <option value="3">ğŸ˜ æ™®é€š</option>
          <option value="2">ğŸ˜ å°‘ã—ã‚ã‚‹ã„</option>
          <option value="1">ğŸ’¤ ã‹ãªã‚Šã‚ã‚‹ã„</option>
        </select>

        <label>ãƒ¡ãƒ³ã‚¿ãƒ«ï¼š</label>
        <select name="mental" required>
          <option value="">é¸æŠ</option>
          <option value="5">ğŸ’ª ã¨ã¦ã‚‚å…ƒæ°—</option>
          <option value="4">ğŸ™‚ å…ƒæ°—</option>
          <option value="3">ğŸ˜Œ æ™®é€š</option>
          <option value="2">ğŸ˜£ ã‚„ã‚„ä¸èª¿</option>
          <option value="1">ğŸ˜­ ã‹ãªã‚Šä¸èª¿</option>
        </select>

        <label>ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šï¼š</label>
        <textarea name="reflection" rows="3" placeholder="ä¾‹ï¼šæˆæ¥­ã§ã€‡ã€‡ã‚’å­¦ã‚“ã ..." required></textarea>

        <label>ç›¸è«‡æ¬„ï¼ˆä»»æ„ï¼‰ï¼š</label>
        <textarea name="consultation" rows="3" placeholder="æ‚©ã¿ãƒ»ç›¸è«‡ãªã©ï¼ˆæ‹…ä»»ã®ã¿é–²è¦§å¯ï¼‰"></textarea>

        <button type="submit">æå‡º</button>
      </form>
    </section>

    <!-- ğŸ“‹ æå‡ºå±¥æ­´ -->
    <section>
      <h2>ğŸ“‹ æå‡ºå±¥æ­´</h2>
      <table>
        <thead>
          <tr>
            <th>æ—¥ä»˜</th>
            <th>ä½“èª¿</th>
            <th>ãƒ¡ãƒ³ã‚¿ãƒ«</th>
            <th>æŒ¯ã‚Šè¿”ã‚Š</th>
            <th>çŠ¶æ…‹</th>
            <th>æ‹…ä»»ã‚³ãƒ¡ãƒ³ãƒˆ</th>
          </tr>
        </thead>
        <tbody>
          <% if (entries && entries.length) { %>
            <% entries.forEach(e => { %>
              <tr>
                <td><%= e.date %></td>
                <td>
                  <% if (e.condition == 5) { %>ğŸŒˆ ã¨ã¦ã‚‚ã‚ˆã„
                  <% } else if (e.condition == 4) { %>ğŸ˜Š ã‚ˆã„
                  <% } else if (e.condition == 3) { %>ğŸ˜ æ™®é€š
                  <% } else if (e.condition == 2) { %>ğŸ˜ å°‘ã—ã‚ã‚‹ã„
                  <% } else if (e.condition == 1) { %>ğŸ’¤ ã‹ãªã‚Šã‚ã‚‹ã„
                  <% } else { %>-<% } %>
                </td>
                <td>
                  <% if (e.mental == 5) { %>ğŸ’ª ã¨ã¦ã‚‚å…ƒæ°—
                  <% } else if (e.mental == 4) { %>ğŸ™‚ å…ƒæ°—
                  <% } else if (e.mental == 3) { %>ğŸ˜Œ æ™®é€š
                  <% } else if (e.mental == 2) { %>ğŸ˜£ ã‚„ã‚„ä¸èª¿
                  <% } else if (e.mental == 1) { %>ğŸ˜­ ã‹ãªã‚Šä¸èª¿
                  <% } else { %>-<% } %>
                </td>
                <td style="text-align:left;"><%= e.reflection || "" %></td>
                <td class="<%= e.is_read ? 'status-read' : 'status-unread' %>">
                  <%= e.is_read ? "âœ… æ—¢èª­" : "â° æœªèª­" %>
                </td>
                <td style="text-align:left;"><%= e.teacher_comment || "-" %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="6">ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
          <% } %>
        </tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { showToast } from "/js/toast.js";

    window.logout = function() {
      if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        sessionStorage.clear();
        window.location.href = "/logout";
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      const msgEl = document.getElementById("alertMsg");
      if (!msgEl) return;
      const msg = msgEl.textContent.trim();
      if (!msg) return;

      const urlParams = new URLSearchParams(window.location.search);
      const alertType = urlParams.get("alert");
      const type = (alertType === "success") ? "success" : "error";

      if (!sessionStorage.getItem("toastShown")) {
        showToast(msg, type, 3500);
        sessionStorage.setItem("toastShown", "true");
        if (type === "success") {
          setTimeout(() => {
            const cleanUrl = `/student?user=<%= student.id %>`;
            history.replaceState(null, "", cleanUrl);
          }, 4000);
        }
      }
    });
  </script>
</body>
</html>
