<!-- views/teacher_dashboard.ejs -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title><%= title %></title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    body{font-family:"Segoe UI","Noto Sans JP",sans-serif;background:#f5f7fa;margin:0}
    header{display:flex;justify-content:space-between;align-items:center;background:#0078d4;color:#fff;padding:15px 20px}
    main{max-width:1100px;margin:auto;padding:25px}
    h2{border-left:5px solid #0078d4;padding-left:10px;color:#0078d4;font-weight:600}
    .table-container{overflow-x:auto;margin-bottom:24px}
    table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    th,td{border:1px solid #ddd;padding:6px 8px;text-align:center;vertical-align:middle}
    th{background:#0078d4;color:#fff}
    tr:nth-child(even){background:#f9f9f9}
    button{background:#0078d4;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer}
    button:hover{background:#005fa3}
    .toast{position:fixed;right:16px;bottom:16px;background:#333;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(10px);transition:.25s;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .chart-container canvas{width:100%;max-height:350px;margin-top:30px}
  </style>
</head>
<body>
<header>
  <h1>ğŸ‘¨â€ğŸ« <%= title %>ï¼ˆ<%= teacherName %>ï¼‰</h1>
  <img src="/images/logout.png" alt="logout" onclick="logout()" style="width:36px;height:36px;border-radius:6px;cursor:pointer">
</header>

<main>
  <% const safeUnsubmitted = Array.isArray(unsubmitted) ? unsubmitted : []; %>

  <!-- æå‡ºä¸€è¦§ -->
  <section>
    <h2>ğŸ“‹ æå‡ºä¸€è¦§ï¼ˆç›¸è«‡æ¬„å«ã‚€ï¼‰</h2>
    <div style="margin-bottom:10px;">
      <label>æœŸé–“ï¼š</label>
      <input type="date" id="filterFrom"> ã€œ <input type="date" id="filterTo">
      <button id="btnFilter">çµã‚Šè¾¼ã¿</button>
      <button id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="btnEntryPDF">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
      <button id="btnEntryCSV">ğŸ“„ CSVå‡ºåŠ›</button>
    </div>

    <div class="table-container">
      <table id="entryTable">
        <thead>
          <tr>
            <th>æ—¥ä»˜</th><th>ç”Ÿå¾’å</th><th>ä½“èª¿</th><th>ãƒ¡ãƒ³ã‚¿ãƒ«</th>
            <th>æŒ¯ã‚Šè¿”ã‚Š</th><th>ç›¸è«‡æ¬„</th><th>æ—¢èª­</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <% if (entries && entries.length) { %>
            <% entries.forEach(e => { %>
              <tr id="row-entry-<%= e.id %>" data-date="<%= e.date %>">
                <td><%= e.date %></td>
                <td><%= e.student_name %></td>
                <td><%= ["ğŸ’¤ã‹ãªã‚Šã‚ã‚‹ã„","ğŸ˜å°‘ã—ã‚ã‚‹ã„","ğŸ˜æ™®é€š","ğŸ˜Šã‚ˆã„","ğŸŒˆã¨ã¦ã‚‚ã‚ˆã„"][e.condition-1] || "-" %></td>
                <td><%= ["ğŸ˜­ã‹ãªã‚Šä¸èª¿","ğŸ˜£ã‚„ã‚„ä¸èª¿","ğŸ˜Œæ™®é€š","ğŸ™‚å…ƒæ°—","ğŸ’ªã¨ã¦ã‚‚å…ƒæ°—"][e.mental-1] || "-" %></td>
                <td style="text-align:left;"><%= e.reflection || "" %></td>
                <td style="text-align:left;color:#444;"><%= (e.consultation||"").trim() || "-" %></td>
                <td class="cell-read-<%= e.id %>"><%= e.is_read ? "âœ…" : "ğŸ”´" %></td>
                <td class="cell-comment-<%= e.id %>" style="color:#0078d4;"><%= e.teacher_comment || "-" %></td>
                <td class="cell-action-<%= e.id %>">
                  <% if (e.is_read) { %>
                    <span>ğŸ”¥ æ¸ˆ</span>
                  <% } else { %>
                    <input type="text" id="comment-<%= e.id %>" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ">
                    <button data-entry="<%= e.id %>" class="btn-readlike">æ—¢èª­ï¼‹ğŸ”¥</button>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="9">ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- æœªæå‡ºè€… -->
  <section>
    <h2>ğŸ“… æœªæå‡ºè€…ä¸€è¦§</h2>
    <div style="margin-bottom:10px;">
      <button id="btnUnsubmittedPDF">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
      <button id="btnUnsubmittedCSV">ğŸ“„ CSVå‡ºåŠ›</button>
    </div>

    <% if (safeUnsubmitted.length === 0) { %>
      <div>å…¨å“¡æå‡ºæ¸ˆã¿ã§ã™ ğŸ‰</div>
      <!-- html2pdfãŒç™½ç´™ã«ãªã‚‰ãªã„ã‚ˆã†ç©ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚ç½®ã„ã¦ãŠã -->
      <div class="table-container">
        <table id="unsubmittedTable"><thead><tr><th>ID</th><th>åå‰</th></tr></thead><tbody></tbody></table>
      </div>
    <% } else { %>
      <div>æœªæå‡ºè€…ãŒ <strong><%= safeUnsubmitted.length %></strong> åã„ã¾ã™ âš ï¸</div>
      <div class="table-container">
        <table id="unsubmittedTable">
          <thead><tr><th>ID</th><th>åå‰</th></tr></thead>
          <tbody>
            <% safeUnsubmitted.forEach(u => { %>
              <tr><td><%= u.id %></td><td><%= u.name %></td></tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>

  <!-- ã‚°ãƒ©ãƒ•ï¼ˆä¸­èº«ã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã§OKï¼‰ -->
  <section class="chart-container">
    <h2>ğŸ“ˆ æå‡ºç‡ãƒ»å¹³å‡ãƒ»æ¨ç§»</h2>
    <canvas id="submissionChart"></canvas>
  </section>
</main>

<div id="toast" class="toast"></div>

<!-- ãƒ•ãƒ­ãƒ³ãƒˆJSï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ä»˜ãï¼‰ -->
<script src="/js/teacher.js?v=20251031_02"></script>
</body>
</html>
