<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title><%= title || "æ‹…ä»»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" %></title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body {
      font-family:"Segoe UI","Noto Sans JP",sans-serif;
      background:#f5f7fa;
      margin:0;padding:0;
    }
    header {
      display:flex;justify-content:space-between;align-items:center;
      background:#0078d4;color:white;padding:15px 20px;font-size:1.2em;
    }
    header img {
      width:36px;height:36px;cursor:pointer;border-radius:6px;transition:.3s;
    }
    header img:hover { background:rgba(255,255,255,0.3); }
    main { max-width:1100px;margin:auto;padding:25px; }
    h2 { border-left:5px solid #0078d4;padding-left:10px;color:#0078d4; }

    .table-container { overflow-x:auto;margin-bottom:25px; }
    table {
      width:100%;border-collapse:collapse;background:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width:850px;
    }
    th,td { border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap; }
    th { background:#0078d4;color:white; }
    tr:nth-child(even){background:#f9f9f9;}
    button { background:#0078d4;color:white;border:none;border-radius:5px;padding:6px 10px;cursor:pointer; }
    button:hover { background:#005fa3; }
    input[type="text"] { border:1px solid #ccc;border-radius:5px;padding:4px;width:180px; }

    /* ğŸ”’ confidential æŠ˜ã‚ŠãŸãŸã¿ãƒœãƒƒã‚¯ã‚¹ */
    .conf-btn {
      background:#0078d4;color:white;border:none;border-radius:5px;
      padding:4px 8px;font-size:0.9em;cursor:pointer;
    }
    .conf-btn:hover { background:#005fa3; }
    .conf-box {
      display:none;
      background:#eef7ff;
      border:1px solid #0078d4;
      border-radius:6px;
      padding:8px;
      margin-top:4px;
      text-align:left;
      white-space:pre-wrap;
    }

    .chart-container { margin-top:30px; }
    @media (max-width:768px){
      header{flex-direction:column;align-items:flex-start;gap:10px;}
      main{padding:15px;}
      table{font-size:0.9em;}
      th,td{padding:6px;}
    }
  </style>
</head>
<body>
<header>
  <h1>ğŸ‘¨â€ğŸ« <%= title %>ï¼ˆ<%= teacherName %>ï¼‰</h1>
  <img src="/images/logout.png" alt="logout" onclick="logout()">
</header>

<main>
  <% const safeUnsubmitted = (typeof unsubmitted !== "undefined" && Array.isArray(unsubmitted)) ? unsubmitted : []; %>

  <!-- ğŸ“‹ æå‡ºä¸€è¦§ -->
  <section>
    <h2>ğŸ“‹ æå‡ºä¸€è¦§ï¼ˆç›¸è«‡æ¬„å«ã‚€ï¼‰</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>æ—¥ä»˜</th>
            <th>ç”Ÿå¾’å</th>
            <th>ä½“èª¿</th>
            <th>ãƒ¡ãƒ³ã‚¿ãƒ«</th>
            <th>æŒ¯ã‚Šè¿”ã‚Š</th>
            <th>ç›¸è«‡æ¬„</th>
            <th>æ—¢èª­</th>
            <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <% if (entries && entries.length) { %>
            <% entries.forEach(e => { %>
              <tr>
                <td><%= e.date %></td>
                <td><%= e.student_name %></td>
                <td>
                  <% if(e.condition==5){ %>ğŸŒˆ ã¨ã¦ã‚‚ã‚ˆã„
                  <% } else if(e.condition==4){ %>ğŸ˜Š ã‚ˆã„
                  <% } else if(e.condition==3){ %>ğŸ˜ æ™®é€š
                  <% } else if(e.condition==2){ %>ğŸ˜ å°‘ã—ã‚ã‚‹ã„
                  <% } else if(e.condition==1){ %>ğŸ’¤ ã‹ãªã‚Šã‚ã‚‹ã„
                  <% } else { %>-<% } %>
                </td>
                <td>
                  <% if(e.mental==5){ %>ğŸ’ª ã¨ã¦ã‚‚å…ƒæ°—
                  <% } else if(e.mental==4){ %>ğŸ™‚ å…ƒæ°—
                  <% } else if(e.mental==3){ %>ğŸ˜Œ æ™®é€š
                  <% } else if(e.mental==2){ %>ğŸ˜£ ã‚„ã‚„ä¸èª¿
                  <% } else if(e.mental==1){ %>ğŸ˜­ ã‹ãªã‚Šä¸èª¿
                  <% } else { %>-<% } %>
                </td>

                <td style="text-align:left;"><%= e.reflection || "" %></td>

                <!-- âœ… ç›¸è«‡æ¬„ -->
                <td style="text-align:left;color:#444;">
                  <% if (e.consultation && e.consultation.trim() !== "") { %>
                    <%= e.consultation %>
                  <% } else { %>
                    -
                  <% } %>
                </td>

                <td><%= e.is_read ? "âœ…" : "ğŸ”´" %></td>
                <td style="text-align:left;color:#0078d4;"><%= e.teacher_comment || "-" %></td>
                <td>
                  <% if(e.is_read){ %>
                    <span>ğŸ”¥ æ¸ˆ</span>
                  <% } else { %>
                    <input type="text" id="comment-<%= e.id %>" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ">
                    <button onclick="markChecked(<%= e.id %>)">æ—¢èª­ï¼‹ğŸ”¥</button>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="9">ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ğŸ“… æœªæå‡ºè€…ä¸€è¦§ -->
  <section>
    <h2>ğŸ“… æœªæå‡ºè€…ä¸€è¦§ï¼ˆ<%= new Date().toISOString().split('T')[0] %>ï¼‰</h2>
    <% if (safeUnsubmitted.length > 0) { %>
      <div class="table-container">
        <table>
          <thead><tr><th>ID</th><th>åå‰</th></tr></thead>
          <tbody>
            <% safeUnsubmitted.forEach(u => { %>
              <tr><td><%= u.id %></td><td><%= u.name %></td></tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p style="color:green;">å…¨å“¡æå‡ºæ¸ˆã¿ã§ã™ ğŸ‰</p>
    <% } %>
  </section>

  <!-- ğŸ“ˆ ä»Šæ—¥ã®æå‡ºç‡ -->
  <section>
    <h2>ğŸ“ˆ ä»Šæ—¥ã®æå‡ºç‡</h2>
    <canvas id="submissionChart"></canvas>
  </section>

  <!-- ğŸ“Š ã‚¯ãƒ©ã‚¹å¹³å‡ -->
  <section class="chart-container">
    <h2>ğŸ“Š ã‚¯ãƒ©ã‚¹å¹³å‡</h2>
    <canvas id="avgChart"></canvas>
  </section>

  <!-- ğŸ“ˆ æ—¥åˆ¥æ¨ç§» -->
  <section class="chart-container">
    <h2>ğŸ“ˆ ã‚¯ãƒ©ã‚¹å¹³å‡ï¼ˆæ—¥åˆ¥æ¨ç§»ï¼‰</h2>
    <canvas id="trendChart"></canvas>
  </section>

  <!-- ğŸ“Š æå‡ºæ•°ã‚°ãƒ©ãƒ• -->
  <section class="chart-container">
    <h2>ğŸ“Š æå‡ºæ•°ã‚°ãƒ©ãƒ•</h2>
    <canvas id="submitChart"></canvas>
  </section>

  <!-- ğŸ“ˆ æ—¥åˆ¥æå‡ºç‡ã®æ¨ç§» -->
  <section class="chart-container">
    <h2>ğŸ“ˆ æ—¥åˆ¥æå‡ºç‡ã®æ¨ç§»</h2>
    <div style="background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
      <canvas id="rateChart"></canvas>
    </div>
  </section>
</main>

<!-- ====================== JS ====================== -->
<script>
  // ğŸ”¥ æ—¢èª­ï¼‹ã‚³ãƒ¡ãƒ³ãƒˆ
  async function markChecked(id) {
    const comment = document.getElementById(`comment-${id}`)?.value || "";
    try {
      const res = await fetch(`/teacher/readlike/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ comment })
      });
      if (res.ok) {
        alert("âœ… æ—¢èª­ï¼‹ğŸ”¥ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼");
        location.reload();
      } else {
        alert("âŒ å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    } catch (err) {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      console.error(err);
    }
  }

  // ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
  function logout() {
    if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) window.location.href = "/logout";
  }

  // ğŸ“ˆ æå‡ºç‡ã‚°ãƒ©ãƒ•
  const submissionRate = <%- submissionRate || 0 %>;
  const unsubmittedRate = 100 - submissionRate;
  new Chart(document.getElementById("submissionChart"), {
    type: "doughnut",
    data: {
      labels: ["æå‡ºæ¸ˆã¿", "æœªæå‡º"],
      datasets: [{ data: [submissionRate, unsubmittedRate], backgroundColor: ["#4e79a7", "#f28e2b"] }]
    },
    options: {
      plugins: { legend: { position: "bottom" }, title: { display: true, text: `æå‡ºç‡ï¼š${submissionRate}%` } },
      cutout: "65%"
    }
  });

  // ğŸ“Š ã‚¯ãƒ©ã‚¹å¹³å‡
  new Chart(document.getElementById("avgChart"), {
    type: "bar",
    data: {
      labels: ["ä½“èª¿", "ãƒ¡ãƒ³ã‚¿ãƒ«"],
      datasets: [{ data: [<%= avgCondition %>, <%= avgMental %>], backgroundColor: ["#4e79a7", "#f28e2b"] }]
    },
    options: { scales: { y: { beginAtZero: true, max: 5, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
  });

  // ğŸ“ˆ ã‚¯ãƒ©ã‚¹å¹³å‡ï¼ˆæ—¥åˆ¥æ¨ç§»ï¼‰
  new Chart(document.getElementById("trendChart"), {
    type: "line",
    data: {
      labels: <%- JSON.stringify(trendLabels || []) %>,
      datasets: [
        { label: "ä½“èª¿", data: <%- JSON.stringify(trendCondition || []) %>, borderColor: "#4e79a7", backgroundColor: "rgba(78,121,167,0.2)", fill: true, tension: 0.2 },
        { label: "ãƒ¡ãƒ³ã‚¿ãƒ«", data: <%- JSON.stringify(trendMental || []) %>, borderColor: "#f28e2b", backgroundColor: "rgba(242,142,43,0.2)", fill: true, tension: 0.2 }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true, max: 5 } }, plugins: { legend: { position: "bottom" } } }
  });

  // ğŸ“Š æå‡ºæ•°ã‚°ãƒ©ãƒ•
  async function loadGraph() {
    const res = await fetch("/teacher/records");
    const data = await res.json();
    const stats = {};
    data.forEach(r => { if (!r.date) return; stats[r.date] = (stats[r.date] || 0) + 1; });
    const labels = Object.keys(stats);
    const values = Object.values(stats);
    new Chart(document.getElementById("submitChart"), {
      type: "bar",
      data: { labels, datasets: [{ label: "æå‡ºæ•°", data: values, backgroundColor: "rgba(54,162,235,0.6)", borderColor: "rgba(54,162,235,1)", borderWidth: 1 }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  }
  document.addEventListener("DOMContentLoaded", loadGraph);

  // ğŸ“ˆ æ—¥åˆ¥æå‡ºç‡ã®æ¨ç§»
  document.addEventListener("DOMContentLoaded", () => {
    const ctx = document.getElementById("rateChart");
    if (!ctx) return;

    const labels = <%- JSON.stringify(rateLabels) %>;
    const data = <%- JSON.stringify(rateValues) %>;

    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "æå‡ºç‡ï¼ˆï¼…ï¼‰",
          data: data,
          fill: false,
          borderColor: "#0078d4",
          backgroundColor: "#0078d4",
          tension: 0.2,
          pointRadius: 4,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: "æå‡ºç‡ï¼ˆï¼…ï¼‰" } },
          x: { title: { display: true, text: "æ—¥ä»˜" } }
        },
        plugins: { legend: { display: true, position: "bottom" } }
      }
    });
  });
</script>
</body>
</html>
