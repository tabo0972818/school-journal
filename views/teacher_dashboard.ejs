<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title><%= title || "æ‹…ä»»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" %></title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">

  <style>
    body {
      font-family: "Segoe UI", "Noto Sans JP", sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0078d4;
      color: white;
      padding: 15px 20px;
      font-size: 1.2em;
    }

    header img {
      width: 36px;
      height: 36px;
      cursor: pointer;
      border-radius: 6px;
      transition: 0.3s;
    }
    header img:hover { background: rgba(255,255,255,0.3); }

    main {
      max-width: 1100px;
      margin: auto;
      padding: 25px;
    }

    h2 {
      border-left: 5px solid #0078d4;
      padding-left: 10px;
      color: #0078d4;
      font-weight: 600;
    }

    .table-container {
      overflow-x: auto;
      margin-bottom: 25px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      table-layout: auto;
      word-wrap: break-word;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
      white-space: normal;
      vertical-align: middle;
    }

    th { background: #0078d4; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }

    button {
      background: #0078d4;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 6px 10px;
      cursor: pointer;
      margin-right: 4px;
      transition: 0.3s;
    }
    button:hover { background: #005fa3; }

    input[type="text"], input[type="date"] {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 4px;
      width: 160px;
      margin-right: 4px;
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #333;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: .25s;
      z-index: 1000;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    .chart-container canvas {
      width: 100%;
      max-height: 350px;
      margin-top: 30px;
    }
  </style>
</head>

<body>
<header>
  <h1>ğŸ‘¨â€ğŸ« <%= title %>ï¼ˆ<%= teacherName %>ï¼‰</h1>
  <img src="/images/logout.png" alt="logout" onclick="logout()">
</header>

<main>
  <% const safeUnsubmitted = Array.isArray(unsubmitted) ? unsubmitted : []; %>

  <!-- ğŸ“‹ æå‡ºä¸€è¦§ -->
  <section id="sectionEntries">
    <h2>ğŸ“‹ æå‡ºä¸€è¦§ï¼ˆç›¸è«‡æ¬„å«ã‚€ï¼‰</h2>
    <div style="margin-bottom:10px;">
      <label>æœŸé–“ï¼š</label>
      <input type="date" id="filterFrom"> ï½ 
      <input type="date" id="filterTo">
      <button onclick="filterByRange()">çµã‚Šè¾¼ã¿</button>
      <button onclick="resetRange()">ãƒªã‚»ãƒƒãƒˆ</button>
      <button onclick="exportToPDF('entryTable','class_entries','<%= grade %><%= className %> æå‡ºä¸€è¦§ï¼ˆç›¸è«‡æ¬„ä»˜ãï¼‰')">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
      <button onclick="exportToCSV('entryTable','class_entries')">ğŸ“„ CSVå‡ºåŠ›</button>
    </div>

    <div class="table-container">
      <table id="entryTable">
        <thead>
          <tr>
            <th>æ—¥ä»˜</th><th>ç”Ÿå¾’å</th><th>ä½“èª¿</th><th>ãƒ¡ãƒ³ã‚¿ãƒ«</th>
            <th>æŒ¯ã‚Šè¿”ã‚Š</th><th>ç›¸è«‡æ¬„</th><th>æ—¢èª­</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <% if (entries && entries.length) { %>
            <% entries.forEach(e => { %>
              <tr id="row-entry-<%= e.id %>" data-date="<%= e.date %>">
                <td><%= e.date %></td>
                <td><%= e.student_name %></td>
                <td><%= ["ğŸ’¤ã‹ãªã‚Šã‚ã‚‹ã„","ğŸ˜å°‘ã—ã‚ã‚‹ã„","ğŸ˜æ™®é€š","ğŸ˜Šã‚ˆã„","ğŸŒˆã¨ã¦ã‚‚ã‚ˆã„"][e.condition-1] || "-" %></td>
                <td><%= ["ğŸ˜­ã‹ãªã‚Šä¸èª¿","ğŸ˜£ã‚„ã‚„ä¸èª¿","ğŸ˜Œæ™®é€š","ğŸ™‚å…ƒæ°—","ğŸ’ªã¨ã¦ã‚‚å…ƒæ°—"][e.mental-1] || "-" %></td>
                <td style="text-align:left;"><%= e.reflection || "" %></td>
                <td style="text-align:left;color:#444;"><%= (e.consultation||"").trim() || "-" %></td>
                <td class="cell-read-<%= e.id %>"><%= e.is_read ? "âœ…" : "ğŸ”´" %></td>
                <td class="cell-comment-<%= e.id %>" style="color:#0078d4;"><%= e.teacher_comment || "-" %></td>
                <td class="cell-action-<%= e.id %>">
                  <% if(e.is_read){ %><span>ğŸ”¥ æ¸ˆ</span><% } else { %>
                    <input type="text" id="comment-<%= e.id %>" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ">
                    <button data-entry="<%= e.id %>" class="btn-readlike">æ—¢èª­ï¼‹ğŸ”¥</button>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="9">ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ğŸ“… æœªæå‡ºè€…ä¸€è¦§ -->
  <section id="sectionUnsubmitted">
    <h2>ğŸ“… æœªæå‡ºè€…ä¸€è¦§</h2>
    <div style="margin-bottom:10px;">
      <button onclick="exportToPDF('unsubmittedTable','unsubmitted_list','<%= grade %><%= className %> æœªæå‡ºè€…ä¸€è¦§')">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
      <button onclick="exportToCSV('unsubmittedTable','unsubmitted_list')">ğŸ“„ CSVå‡ºåŠ›</button>
    </div>
    <% if (safeUnsubmitted.length === 0) { %>
      <div>å…¨å“¡æå‡ºæ¸ˆã¿ã§ã™ ğŸ‰</div>
    <% } else { %>
      <div>æœªæå‡ºè€…ãŒ <strong><%= safeUnsubmitted.length %></strong> åã„ã¾ã™ âš ï¸</div>
      <div class="table-container">
        <table id="unsubmittedTable">
          <thead><tr><th>ID</th><th>åå‰</th></tr></thead>
          <tbody>
            <% safeUnsubmitted.forEach(u => { %>
              <tr><td><%= u.id %></td><td><%= u.name %></td></tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>

  <!-- ğŸ“Š ã‚°ãƒ©ãƒ•ç¾¤ -->
  <section class="chart-container">
    <h2>ğŸ“ˆ æå‡ºç‡ãƒ»å¹³å‡ãƒ»æ¨ç§»</h2>
    <canvas id="submissionChart"></canvas>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
(function(){
  const jstToday = ()=>new Date(Date.now()+9*60*60*1000).toISOString().slice(0,10);

  /* ================= ğŸ“„ PDFå‡ºåŠ› ================= */
  window.exportToPDF = async function(elementId, filename, titleText){
    try{
      const table=document.getElementById(elementId);
      if(!table)return alert("å‡ºåŠ›å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

      const today=jstToday();
      const rows=table.querySelectorAll("tbody tr");
      const hasData=rows.length>0 && !rows[0].innerText.includes("ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“");

      const wrap=document.createElement("div");
      Object.assign(wrap.style,{
        width:"190mm",marginLeft:"auto",marginRight:"auto",background:"#fff",
        textAlign:"center",padding:"8mm 0",fontFamily:"'Noto Sans JP',sans-serif"
      });

      const title=document.createElement("h3");
      title.textContent=`${titleText.replace(/\ï¼ˆ.*?\ï¼‰/,"")}ï¼ˆ${today}ï¼‰`;
      title.style.color="#0078d4";
      title.style.marginBottom="5mm";
      wrap.appendChild(title);

      const clone=table.cloneNode(true);
      Object.assign(clone.style,{width:"95%",margin:"auto",borderCollapse:"collapse",tableLayout:"auto"});
      clone.querySelectorAll("th,td").forEach(td=>{
        td.style.border="1px solid #999";
        td.style.fontSize="11px";
        td.style.padding="5px 6px";
        td.style.textAlign="center";
        td.style.whiteSpace="normal";
        td.style.wordBreak="break-word";
      });
      clone.querySelectorAll("th").forEach(th=>{th.style.background="#0078d4";th.style.color="#fff";});

      if(hasData){
        clone.querySelectorAll("tr").forEach(row=>{
          for(let i=0;i<3;i++)row.deleteCell(-1);
        });
      }
      wrap.appendChild(clone);

      if(!hasData){
        const msg=document.createElement("div");
        msg.textContent="ã¾ã æå‡ºãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        msg.style.textAlign="center";
        msg.style.fontSize="16px";
        msg.style.marginTop="25px";
        wrap.appendChild(msg);
      }

      document.body.appendChild(wrap);
      await html2pdf().set({
        margin:[10,10,10,10],
        filename:`${filename}_${today}.pdf`,
        image:{type:"jpeg",quality:1},
        html2canvas:{scale:2,useCORS:true,backgroundColor:"#fff"},
        jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}
      }).from(wrap).save();
      wrap.remove();
    }catch(e){console.error(e);alert("PDFå‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");}
  };

  /* ================= CSVå‡ºåŠ› ================= */
  window.exportToCSV=function(tableId,filename){
    const table=document.getElementById(tableId);
    if(!table)return alert("å‡ºåŠ›å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    const today=jstToday();
    const rows=[...table.querySelectorAll("tr")];
    const csv=rows.map(r=>{
      const cells=[...r.querySelectorAll("th,td")];
      if(cells.length>2)cells.pop();
      return cells.map(c=>`"${(c.innerText||"").replace(/"/g,'""')}"`).join(",");
    }).join("\n");
    const blob=new Blob([new Uint8Array([0xEF,0xBB,0xBF]),csv],{type:"text/csv"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download=`${filename}_${today}.csv`;
    link.click();
  };

  /* ================= âœ… æ—¢èª­ï¼‹ğŸ”¥ ================= */
  document.addEventListener("click",async e=>{
    if(!e.target.classList.contains("btn-readlike"))return;
    const id=e.target.dataset.entry;
    const comment=document.getElementById("comment-"+id)?.value.trim()||"";
    try{
      const res=await fetch(`/teacher/readlike/${id}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({comment})
      });
      const data=await res.json();
      if(data.success){
        document.querySelector(".cell-read-"+id).innerText="âœ…";
        document.querySelector(".cell-comment-"+id).innerText=comment||"-";
        document.querySelector(".cell-action-"+id).innerHTML="<span>ğŸ”¥ æ¸ˆ</span>";
        showToast("æ—¢èª­ï¼‹ğŸ”¥ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
      }else showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }catch(err){console.error(err);showToast("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");}
  });

  function showToast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2000);
  }

  /* ================= ã‚°ãƒ©ãƒ•æç”» ================= */
  document.addEventListener("DOMContentLoaded",()=>{
    const c=document.getElementById("submissionChart");
    if(!c)return;

    const trendLabels=<%- JSON.stringify(trendLabels||[]) %>;
    const trendCondition=<%- JSON.stringify(trendCondition||[]) %>;
    const trendMental=<%- JSON.stringify(trendMental||[]) %>;
    const rateLabels=<%- JSON.stringify(rateLabels||[]) %>;
    const rateValues=<%- JSON.stringify(rateValues||[]) %>;
    const submissionRate=<%- Number(submissionRate||0) %>;
    const avgCondition=<%- Number(avgCondition||0) %>;
    const avgMental=<%- Number(avgMental||0) %>;

    // â‘  å††ã‚°ãƒ©ãƒ•
    new Chart(c,{type:"doughnut",data:{labels:["æå‡ºæ¸ˆ","æœªæå‡º"],datasets:[{data:[submissionRate,100-submissionRate],backgroundColor:["#0078d4","#ccc"]}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"æå‡ºç‡ï¼ˆå…¨ä½“ï¼‰",font:{size:16}},legend:{position:"bottom"}}}
    });

    // â‘¡ å¹³å‡æ£’ã‚°ãƒ©ãƒ•
    const avgCanvas=document.createElement("canvas");
    c.parentElement.appendChild(avgCanvas);
    new Chart(avgCanvas.getContext("2d"),{type:"bar",
      data:{labels:["ä½“èª¿","ãƒ¡ãƒ³ã‚¿ãƒ«"],datasets:[{data:[avgCondition,avgMental],backgroundColor:["#4caf50","#ff9800"]}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"å¹³å‡å€¤ï¼ˆä½“èª¿ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«ï¼‰",font:{size:16}}},scales:{y:{min:0,max:5,ticks:{stepSize:1}}}}
    });

    // â‘¢ ä½“èª¿ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«æ¨ç§»
    const trendCanvas=document.createElement("canvas");
    c.parentElement.appendChild(trendCanvas);
    new Chart(trendCanvas.getContext("2d"),{
      type:"line",
      data:{labels:trendLabels,datasets:[
        {label:"ä½“èª¿å¹³å‡",data:trendCondition,borderColor:"#0078d4",fill:false,tension:0.3,pointRadius:6,spanGaps:true},
        {label:"ãƒ¡ãƒ³ã‚¿ãƒ«å¹³å‡",data:trendMental,borderColor:"#ff9800",fill:false,tension:0.3,pointRadius:6,spanGaps:true}
      ]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"æ—¥åˆ¥å¹³å‡æ¨ç§»",font:{size:16}},legend:{position:"bottom"}},scales:{y:{min:0,max:5,ticks:{stepSize:1}}}}
    });

    // â‘£ æå‡ºç‡æ¨ç§»
    const rateCanvas=document.createElement("canvas");
    c.parentElement.appendChild(rateCanvas);
    new Chart(rateCanvas.getContext("2d"),{
      type:"line",
      data:{labels:rateLabels,datasets:[
        {label:"æå‡ºç‡(%)",data:rateValues,borderColor:"#4caf50",fill:false,tension:0.3,pointRadius:6,spanGaps:true}
      ]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"æ—¥åˆ¥æå‡ºç‡ã®æ¨ç§»",font:{size:16}},legend:{position:"bottom"}},scales:{y:{min:0,max:100,ticks:{stepSize:10}}}}
    });
  });

  /* ================= ãã®ä»– ================= */
  window.logout=()=>{if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ"))location.href="/logout";};
  window.filterByRange=()=>{const f=document.querySelector("#filterFrom").value;const t=document.querySelector("#filterTo").value;
    document.querySelectorAll("#entryTable tbody tr").forEach(r=>{const d=r.dataset.date;r.style.display=(!f||d>=f)&&(!t||d<=t)?"":"none";});
  };
  window.resetRange=()=>{document.querySelector("#filterFrom").value="";document.querySelector("#filterTo").value="";document.querySelectorAll("#entryTable tbody tr").forEach(r=>r.style.display="");};
})();
</script>
</body>
</html>
