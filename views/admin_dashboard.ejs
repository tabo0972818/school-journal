<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title><%= title || "管理者ダッシュボード" %></title>

  <!-- 共通スタイル -->
  <link rel="stylesheet" href="/css/style.css" />

  <!-- Chart.js（統計グラフ） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ✅ PDF用ライブラリはローカル読込（iOS Safari白画面対策） -->
  <!-- ※ html2pdf.bundle は使用しない。html2canvas + jsPDF の軽量構成で安定化 -->
  <script src="/js/vendor/html2canvas.min.js" defer></script>
  <script src="/js/vendor/jspdf.umd.min.js" defer></script>

 
</head>

<body>
<header>
  <h1>👨‍💼 管理者ダッシュボード</h1>
  <img src="/images/logout.png" alt="logout" id="logoutBtn">
</header>

<main>
  <!-- 📊 KPI -->
  <section>
    <h2>📊 統計</h2>
    <div class="grid cols-4">
      <div class="card kpi"><span class="label">提出総数</span><span class="value"><%= totalEntries %></span></div>
      <div class="card kpi"><span class="label">未読</span><span class="value"><%= unreadCount %></span></div>
      <div class="card kpi"><span class="label">既読</span><span class="value"><%= readCount %></span></div>
      <div class="card kpi"><span class="label">平均 体調 / メンタル</span><span class="value"><%= avgCondition %> / <%= avgMental %></span></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end">
      <form action="/admin/reset" method="post" onsubmit="return confirm('提出データを全削除して初期化します。よろしいですか？')">
        <button class="danger">🧹 提出データ 初期化</button>
      </form>
    </div>
  </section>

  <!-- 📈 グラフ -->
  <section>
    <h2>📈 グラフ</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr;">
      <div class="card">
        <h3 style="margin:.2rem 0 .6rem">日別・提出件数</h3>
        <canvas id="submissionsChart" height="120"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:.2rem 0 .6rem">日別・平均 体調／メンタル</h3>
        <canvas id="avgChart" height="120"></canvas>
      </div>
    </div>
  </section>

  <!-- ➕ アカウント追加 -->
  <section>
    <div class="space-between">
      <h2>➕ アカウント追加・更新</h2>
      <span class="muted">既存IDで送信すると更新、未登録IDなら追加になります。</span>
    </div>
    <form action="/admin/addUser" method="post" class="card" id="addUserForm">
      <div class="row">
        <div><label for="id">ID</label><input id="id" name="id" type="text" required></div>
        <div><label for="name">名前</label><input id="name" name="name" type="text" required></div>
        <div><label for="role">役割</label>
          <select id="role" name="role" required>
            <option value="student">student（生徒）</option>
            <option value="teacher">teacher（担任）</option>
            <option value="admin">admin（管理者）</option>
          </select>
        </div>
        <div><label for="password">パスワード</label><input id="password" name="password" type="text" required></div>
      </div>
      <div class="row">
        <div><label for="grade">学年</label>
          <select id="grade" name="grade" required>
            <option value="">選択</option><option value="1">1年</option><option value="2">2年</option><option value="3">3年</option>
          </select>
        </div>
        <div><label for="class_name">クラス</label>
          <select id="class_name" name="class_name" required>
            <option value="">選択</option><option value="A">A組</option><option value="B">B組</option><option value="C">C組</option>
          </select>
        </div>
        <div class="text-right"><label>&nbsp;</label><button type="submit">💾 登録 / 更新</button></div>
      </div>
    </form>
  </section>

  <!-- 🔍 ユーザー一覧（フィルター付き） -->
  <section>
    <div class="space-between">
      <h2>🔍 ユーザー一覧（フィルター付き）</h2>
      <div class="toolbar">
        <button class="secondary nowrap" id="usersPdfBtn">🖨️ PDF出力</button>
        <button class="secondary nowrap" id="usersCsvBtn">📄 CSV出力</button>
      </div>
    </div>

    <!-- フィルター -->
    <div class="card">
      <div class="row">
        <div><label for="filterGrade">学年</label>
          <select id="filterGrade"><option value="">すべて</option><option value="1">1年</option><option value="2">2年</option><option value="3">3年</option></select>
        </div>
        <div><label for="filterClass">クラス</label>
          <select id="filterClass"><option value="">すべて</option><option value="A">A組</option><option value="B">B組</option><option value="C">C組</option></select>
        </div>
        <div><label for="filterRole">役割</label>
          <select id="filterRole"><option value="">すべて</option><option value="student">student</option><option value="teacher">teacher</option><option value="admin">admin</option></select>
        </div>
        <div><label for="filterKeyword">キーワード（ID/名前）</label>
          <input id="filterKeyword" type="text" placeholder="例: yamada / student1A">
        </div>
        <div class="text-right"><label>&nbsp;</label><button class="secondary" id="usersClearBtn">🧼 クリア</button></div>
      </div>
    </div>

    <!-- 一覧 -->
    <div id="userTableArea" class="section">
      <table id="userTable">
        <thead>
          <tr>
            <th>ID</th><th>名前</th><th>学年</th><th>クラス</th><th>役割</th><th class="ops">操作</th>
          </tr>
        </thead>
        <tbody id="userTbody">
          <% users.forEach(u=>{ %>
            <tr data-grade="<%= u.grade %>" data-class="<%= u.class_name %>" data-role="<%= u.role %>" data-id="<%= u.id %>" data-name="<%= u.name %>">
              <td><span class="badge"><%= u.id %></span></td>
              <td><%= u.name %></td>
              <td><%= u.grade %></td>
              <td><%= u.class_name %></td>
              <td><%= u.role %></td>
              <td class="actions ops">
                <form action="/admin/deleteUser/<%= u.id %>" method="post" onsubmit="return confirm('ID: <%= u.id %> を削除します。よろしいですか？')">
                  <button class="danger">🗑️ 削除</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- 🧾 操作ログ -->
  <section>
    <div class="space-between">
      <h2>🧾 操作ログ</h2>
      <div class="toolbar">
        <button class="secondary nowrap" id="logsPdfBtn">🖨️ PDF出力</button>
        <button class="secondary nowrap" id="logsCsvBtn">📄 CSV出力</button>
        <form action="/admin/logs/clear" method="post" onsubmit="return confirm('操作ログを全削除します。よろしいですか？')">
          <button class="danger nowrap">🧹 ログ全削除</button>
        </form>
      </div>
    </div>

    <!-- ログ フィルター -->
    <div class="card">
      <div class="row">
        <div><label for="logFilterUser">ユーザー（部分一致）</label><input id="logFilterUser" type="text" placeholder="例: yamada / 1A"></div>
        <div><label for="logFilterAction">操作（部分一致）</label><input id="logFilterAction" type="text" placeholder="例: ログイン / 追加"></div>
        <div><label for="logFilterDateFrom">日付（自）</label><input id="logFilterDateFrom" type="date"></div>
        <div><label for="logFilterDateTo">日付（至）</label><input id="logFilterDateTo" type="date"></div>
        <div class="text-right"><label>&nbsp;</label><button class="secondary" id="logsClearBtn">🧼 クリア</button></div>
      </div>
    </div>

    <!-- ログ一覧 -->
    <div id="logTableArea" class="section">
      <table id="logTable">
        <thead><tr><th>ID</th><th>ユーザー</th><th>操作</th><th>日時</th></tr></thead>
        <tbody id="logTbody">
          <% logs.forEach(l => { %>
            <tr data-user="<%= l.user_name || '' %>" data-action="<%= l.action || '' %>" data-time="<%= l.time || '' %>">
              <td><%= l.id %></td><td><%= l.user_name %></td><td><%= l.action %></td><td><%= l.time %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>
</main>

<!-- グラフ用データ -->
<script>window.__ENTRIES__ = <%- JSON.stringify(entries || []) %>;</script>

<!-- 画面用JS -->
<script src="/js/dashboard_admin.js" defer></script>
</body>
</html>
