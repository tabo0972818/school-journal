<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title><%= title || "ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" %></title>
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body{font-family:"Noto Sans JP",sans-serif;background:#f5f7fa;margin:0;}
    header{display:flex;justify-content:space-between;align-items:center;background:#0078d4;color:#fff;padding:15px 20px;font-size:1.2em;}
    header img{width:36px;height:36px;cursor:pointer;border-radius:6px;}
    main{max-width:1200px;margin:auto;padding:24px;}
    h2{border-left:5px solid #0078d4;padding-left:10px;color:#0078d4;margin:24px 0 12px;}
    .grid{display:grid;gap:14px;}
    .grid.cols-4{grid-template-columns:repeat(4,1fr);}
    .card{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:14px;}
    .kpi{display:flex;flex-direction:column;gap:4px;}
    .kpi .label{color:#555;font-size:.9rem;}
    .kpi .value{font-size:1.6rem;font-weight:700;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end;}
    .row > *{flex:1 1 180px;}
    label{display:block;font-size:.9rem;color:#444;margin:.25rem 0;}
    input,select{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;}
    button{background:#0078d4;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;}
    button.secondary{background:#fff;color:#0078d4;border:1px solid #0078d4;}
    button.danger{background:#dc3545;}
    button:hover{filter:brightness(.95);}
    table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.08);}
    th,td{border:1px solid #eee;padding:10px;text-align:center;}
    th{background:#0078d4;color:#fff;position:sticky;top:0;}
    tr:nth-child(even){background:#fafafa;}
    .actions{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px;}
    .muted{color:#666;font-size:.9rem;}
    .right{justify-content:flex-end;}
    .space-between{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .nowrap{white-space:nowrap;}
    .section{margin-top:32px;}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ddd;font-size:.8rem;background:#fff;}
    .text-right{text-align:right;}
    @media (max-width:900px){
      .grid.cols-4{grid-template-columns:repeat(2,1fr);}
    }
  </style>
</head>
<body>
<header>
  <h1>ğŸ‘¨â€ğŸ’¼ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <img src="/images/logout.png" alt="logout" onclick="logout()">
</header>

<main>
  <!-- ğŸ“Š KPI / çµ±è¨ˆ -->
  <section class="section">
    <h2>ğŸ“Š çµ±è¨ˆ</h2>
    <div class="grid cols-4">
      <div class="card kpi"><span class="label">æå‡ºç·æ•°</span><span class="value"><%= totalEntries %></span></div>
      <div class="card kpi"><span class="label">æœªèª­</span><span class="value"><%= unreadCount %></span></div>
      <div class="card kpi"><span class="label">æ—¢èª­</span><span class="value"><%= readCount %></span></div>
      <div class="card kpi"><span class="label">å¹³å‡ ä½“èª¿ / ãƒ¡ãƒ³ã‚¿ãƒ«</span><span class="value"><%= avgCondition %> / <%= avgMental %></span></div>
    </div>
    <div class="toolbar right">
      <form action="/admin/reset" method="post" onsubmit="return confirm('æå‡ºãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
        <button class="danger">ğŸ§¹ æå‡ºãƒ‡ãƒ¼ã‚¿ åˆæœŸåŒ–</button>
      </form>
    </div>
  </section>

  <!-- â• ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ  / æ›´æ–° -->
  <section class="section">
    <div class="space-between">
      <h2>â• ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ ãƒ»æ›´æ–°</h2>
      <span class="muted">æ—¢å­˜IDã§é€ä¿¡ã™ã‚‹ã¨ã€Œæ›´æ–°ã€ã€æœªç™»éŒ²IDãªã‚‰ã€Œè¿½åŠ ã€ã«ãªã‚Šã¾ã™ã€‚</span>
    </div>
    <form action="/admin/addUser" method="post" class="card">
      <div class="row">
        <div><label for="id">ID</label><input id="id" name="id" type="text" placeholder="ä¾‹: student1A01 / teacher2B" required></div>
        <div><label for="name">åå‰</label><input id="name" name="name" type="text" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" required></div>
        <div><label for="role">å½¹å‰²</label>
          <select id="role" name="role" required>
            <option value="student">studentï¼ˆç”Ÿå¾’ï¼‰</option>
            <option value="teacher">teacherï¼ˆæ‹…ä»»ï¼‰</option>
            <option value="admin">adminï¼ˆç®¡ç†è€…ï¼‰</option>
          </select>
        </div>
        <div><label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input id="password" name="password" type="text" placeholder="åˆæœŸ/æ›´æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required></div>
      </div>
      <div class="row">
        <div><label for="grade">å­¦å¹´</label>
          <select id="grade" name="grade" required>
            <option value="">é¸æŠ</option><option value="1">1å¹´</option><option value="2">2å¹´</option><option value="3">3å¹´</option>
          </select>
        </div>
        <div><label for="class_name">ã‚¯ãƒ©ã‚¹</label>
          <select id="class_name" name="class_name" required>
            <option value="">é¸æŠ</option><option value="A">Açµ„</option><option value="B">Bçµ„</option><option value="C">Cçµ„</option>
          </select>
        </div>
        <div class="text-right"><label>&nbsp;</label><button type="submit">ğŸ’¾ ç™»éŒ² / æ›´æ–°</button></div>
      </div>
    </form>
  </section>

  <!-- ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <section class="section">
    <div class="space-between">
      <h2>ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä»˜ãï¼‰</h2>
      <div class="toolbar">
        <button class="secondary nowrap" onclick="exportToPDF('userTableArea','users_list')">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
        <button class="secondary nowrap" onclick="exportToCSV('userTable','users_list')">ğŸ“„ CSVå‡ºåŠ›</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div><label for="filterGrade">å­¦å¹´</label><select id="filterGrade"><option value="">ã™ã¹ã¦</option><option value="1">1å¹´</option><option value="2">2å¹´</option><option value="3">3å¹´</option></select></div>
        <div><label for="filterClass">ã‚¯ãƒ©ã‚¹</label><select id="filterClass"><option value="">ã™ã¹ã¦</option><option value="A">Açµ„</option><option value="B">Bçµ„</option><option value="C">Cçµ„</option></select></div>
        <div><label for="filterRole">å½¹å‰²</label><select id="filterRole"><option value="">ã™ã¹ã¦</option><option value="student">student</option><option value="teacher">teacher</option><option value="admin">admin</option></select></div>
        <div><label for="filterKeyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆID/åå‰ï¼‰</label><input id="filterKeyword" type="text" placeholder="ä¾‹: yamada / student1A"></div>
        <div class="text-right"><label>&nbsp;</label><button class="secondary" onclick="clearUserFilters()">ğŸ§¼ ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>

    <div id="userTableArea" class="section">
      <table id="userTable">
        <thead>
          <tr><th>ID</th><th>åå‰</th><th>å­¦å¹´</th><th>ã‚¯ãƒ©ã‚¹</th><th>å½¹å‰²</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="userTbody">
          <% users.forEach(u=>{ %>
            <tr data-grade="<%= u.grade %>" data-class="<%= u.class_name %>" data-role="<%= u.role %>" data-id="<%= u.id %>" data-name="<%= u.name %>">
              <td><span class="badge"><%= u.id %></span></td>
              <td><%= u.name %></td>
              <td><%= u.grade %></td>
              <td><%= u.class_name %></td>
              <td><%= u.role %></td>
              <td class="actions">
                <form action="/admin/deleteUser/<%= u.id %>" method="post" onsubmit="return confirm('ID: <%= u.id %> ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
                  <button class="danger">ğŸ—‘ï¸ å‰Šé™¤</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ğŸ§¾ æ“ä½œãƒ­ã‚° -->
  <section class="section">
    <div class="space-between">
      <h2>ğŸ§¾ æ“ä½œãƒ­ã‚°</h2>
      <div class="toolbar">
        <button class="secondary nowrap" onclick="exportToPDF('logTableArea','operation_logs')">ğŸ–¨ï¸ PDFå‡ºåŠ›</button>
        <button class="secondary nowrap" onclick="exportToCSV('logTable','operation_logs')">ğŸ“„ CSVå‡ºåŠ›</button>
        <form action="/admin/logs/clear" method="post" onsubmit="return confirm('æ“ä½œãƒ­ã‚°ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
          <button class="danger nowrap">ğŸ§¹ ãƒ­ã‚°å…¨å‰Šé™¤</button>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div><label for="logFilterUser">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label><input id="logFilterUser" type="text" placeholder="ä¾‹: å±±ç”° / teacher1A"></div>
        <div><label for="logFilterAction">æ“ä½œç¨®åˆ¥</label><input id="logFilterAction" type="text" placeholder="ä¾‹: ãƒ­ã‚°ã‚¤ãƒ³ / ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ  ãªã©"></div>
        <div><label for="logFilterDateFrom">æ—¥ä»˜ï¼ˆFromï¼‰</label><input id="logFilterDateFrom" type="date"></div>
        <div><label for="logFilterDateTo">æ—¥ä»˜ï¼ˆToï¼‰</label><input id="logFilterDateTo" type="date"></div>
        <div class="text-right"><label>&nbsp;</label><button class="secondary" onclick="clearLogFilters()">ğŸ§¼ ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>

    <div id="logTableArea" class="section">
      <table id="logTable">
        <thead><tr><th>ID</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>æ“ä½œ</th><th>æ—¥æ™‚</th></tr></thead>
        <tbody id="logTbody">
          <% logs.forEach(l => { %>
            <tr data-user="<%= l.user_name || '' %>" data-action="<%= l.action || '' %>" data-time="<%= l.time || '' %>">
              <td><%= l.id %></td><td><%= l.user_name %></td><td><%= l.action %></td><td><%= l.time %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>
</main>

<script src="../js/dashboard_admin.js"></script>
<script>
  // ===== CSVå‡ºåŠ›ï¼ˆExceläº’æ› / æ“ä½œåˆ—é™¤å¤–ï¼‰ =====
  function exportToCSV(tableId, filename) {
    const table = document.getElementById(tableId);
    if (!table) return alert("å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    const rows = [...table.querySelectorAll("tr")];
    const csv = rows.map(r => {
      const cells = [...r.children].slice(0, -1); // æ“ä½œåˆ—é™¤å¤–
      return cells.map(c => {
        let t = c.innerText || "";
        t = t.replace(/\r?\n/g, " ").replace(/"/g, '""');
        return `"${t}"`;
      }).join(",");
    }).join("\r\n");
    const bom = new Uint8Array([0xEF,0xBB,0xBF]);
    const blob = new Blob([bom, csv], { type:"text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".csv";
    link.click();
  }

  // ===== PDFå‡ºåŠ›ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³åˆ—ã‚’éè¡¨ç¤ºï¼‰ =====
  // ===== PDFå‡ºåŠ›ï¼ˆæ“ä½œåˆ—ã‚’éè¡¨ç¤ºï¼‰ =====
function exportToPDF(elementId, filename) {
  const element = document.getElementById(elementId);
  if (!element) return alert("å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

  // æœ€å¾Œã®ã€Œæ“ä½œã€åˆ—ã‚’éè¡¨ç¤º
  const actionCols = element.querySelectorAll("th:last-child, td:last-child");
  actionCols.forEach(el => (el.style.display = "none"));

  const opt = {
    margin: [10, 10, 10, 10],
    filename: filename + ".pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
    pagebreak: { mode: ["avoid-all", "css", "legacy"] }
  };

  html2pdf().set(opt).from(element).save().then(() => {
    // å…ƒã«æˆ»ã™
    actionCols.forEach(el => (el.style.display = ""));
  }).catch(() => {
    actionCols.forEach(el => (el.style.display = ""));
  });
}

  // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
  function logout(){ if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) location.href="/logout"; }
</script>
</body>
</html>
